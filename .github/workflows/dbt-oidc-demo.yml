name: â„ï¸ dbt CI/CD via OIDC (Zero Secrets)

on:
  workflow_dispatch:

env:
  SNOWFLAKE_ACCOUNT: sfsenorthamerica-gen_ai_hol
  SNOWFLAKE_USER: github_actions_dbt
  SNOWFLAKE_DATABASE: AUTOMATED_INTELLIGENCE
  SNOWFLAKE_WAREHOUSE: AUTOMATED_INTELLIGENCE_WH
  SNOWFLAKE_ROLE: SNOWFLAKE_INTELLIGENCE_ADMIN
  DBT_PROFILES_DIR: ${{ github.workspace }}/dbt-analytics

jobs:
  dbt-oidc:
    name: ðŸ” OIDC Auth â†’ dbt Test
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install dependencies
        run: pip install dbt-snowflake snowflake-connector-python

      - name: ðŸ” Get OIDC Token (NO SECRETS STORED!)
        id: auth
        run: |
          echo "ðŸ”‘ Requesting OIDC token from GitHub..."
          TOKEN=$(curl -s -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=snowflakecomputing.com" | jq -r '.value')
          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> $GITHUB_OUTPUT
          echo "âœ… Got short-lived OIDC token"

      - name: ðŸ”§ Generate dbt profile with OIDC token
        env:
          SNOWFLAKE_TOKEN: ${{ steps.auth.outputs.token }}
        run: |
          cat > dbt-analytics/profiles.yml << EOF
          automated_intelligence:
            target: oidc
            outputs:
              oidc:
                type: snowflake
                account: ${SNOWFLAKE_ACCOUNT}
                user: ${SNOWFLAKE_USER}
                role: ${SNOWFLAKE_ROLE}
                warehouse: ${SNOWFLAKE_WAREHOUSE}
                database: ${SNOWFLAKE_DATABASE}
                schema: staging
                threads: 4
                authenticator: oauth
                token: "${SNOWFLAKE_TOKEN}"
          EOF
          echo "âœ… Generated profiles.yml with OIDC token"

      - name: â„ï¸ dbt deps
        working-directory: dbt-analytics
        run: dbt deps

      - name: â„ï¸ dbt test (validates real data)
        working-directory: dbt-analytics
        run: |
          echo "ðŸ“Š Running dbt tests via OIDC authentication..."
          dbt test --select customer_lifetime_value

      - name: ðŸŽ¯ Query Results (proves real access)
        env:
          SNOWFLAKE_TOKEN: ${{ steps.auth.outputs.token }}
        run: |
          python << 'EOF'
          import snowflake.connector
          import os

          print("ðŸ” Connecting to Snowflake via OIDC...")
          conn = snowflake.connector.connect(
              account=os.environ['SNOWFLAKE_ACCOUNT'],
              user=os.environ['SNOWFLAKE_USER'],
              authenticator='WORKLOAD_IDENTITY',
              workload_identity_provider='OIDC',
              token=os.environ['SNOWFLAKE_TOKEN'],
              warehouse=os.environ['SNOWFLAKE_WAREHOUSE'],
              database=os.environ['SNOWFLAKE_DATABASE'],
              role=os.environ['SNOWFLAKE_ROLE']
          )

          cur = conn.cursor()
          cur.execute("""
              SELECT 
                  COUNT(*) as customers,
                  ROUND(SUM(total_revenue), 2) as revenue,
                  ROUND(AVG(total_revenue), 2) as avg_revenue
              FROM DBT_ANALYTICS.CUSTOMER_LIFETIME_VALUE
          """)
          row = cur.fetchone()
          
          print("")
          print("=" * 50)
          print("ðŸŽ¯ LIVE DATA FROM SNOWFLAKE")
          print("=" * 50)
          print(f"   Customers:     {row[0]:,}")
          print(f"   Total Revenue: ${row[1]:,.2f}")
          print(f"   Avg Revenue:   ${row[2]:,.2f}")
          print("=" * 50)
          print("")
          print("âœ… dbt tests passed + data validated")
          print("âœ… Authenticated via GitHub OIDC")
          print("âœ… Zero secrets stored in repository!")
          EOF
