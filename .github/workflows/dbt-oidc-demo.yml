name: ‚ùÑÔ∏è Snowflake OIDC Demo (Zero Secrets)

on:
  workflow_dispatch:

env:
  SNOWFLAKE_ACCOUNT: sfsenorthamerica-gen_ai_hol
  SNOWFLAKE_USER: github_actions_dbt
  SNOWFLAKE_DATABASE: AUTOMATED_INTELLIGENCE
  SNOWFLAKE_WAREHOUSE: AUTOMATED_INTELLIGENCE_WH
  SNOWFLAKE_ROLE: SNOWFLAKE_INTELLIGENCE_ADMIN

jobs:
  snowflake-oidc:
    name: üîê OIDC Auth ‚Üí Query Snowflake
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      
    steps:
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: üì¶ Install Snowflake connector
        run: pip install snowflake-connector-python

      - name: üîê Get OIDC Token (NO SECRETS STORED!)
        id: auth
        run: |
          echo "üîë Requesting OIDC token from GitHub..."
          TOKEN=$(curl -s -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=snowflakecomputing.com" | jq -r '.value')
          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> $GITHUB_OUTPUT
          echo "‚úÖ Got short-lived OIDC token (expires in 10 min)"

      - name: ‚ùÑÔ∏è Query Snowflake (proves real access)
        env:
          SNOWFLAKE_TOKEN: ${{ steps.auth.outputs.token }}
        run: |
          python << 'EOF'
          import snowflake.connector
          import os

          print("üîê Connecting to Snowflake via OIDC...")
          print("   (Zero secrets stored in this repository!)")
          print("")

          conn = snowflake.connector.connect(
              account=os.environ['SNOWFLAKE_ACCOUNT'],
              user=os.environ['SNOWFLAKE_USER'],
              authenticator='WORKLOAD_IDENTITY',
              workload_identity_provider='OIDC',
              token=os.environ['SNOWFLAKE_TOKEN'],
              warehouse=os.environ['SNOWFLAKE_WAREHOUSE'],
              database=os.environ['SNOWFLAKE_DATABASE'],
              role=os.environ['SNOWFLAKE_ROLE']
          )

          cur = conn.cursor()
          
          # Verify identity
          cur.execute("SELECT CURRENT_USER(), CURRENT_ROLE()")
          user, role = cur.fetchone()
          print(f"‚úÖ Authenticated as: {user}")
          print(f"‚úÖ Using role: {role}")
          print("")

          # Query real data
          cur.execute("""
              SELECT 
                  COUNT(*) as customers,
                  ROUND(SUM(total_revenue), 2) as revenue,
                  ROUND(AVG(total_revenue), 2) as avg_revenue
              FROM DBT_ANALYTICS.CUSTOMER_LIFETIME_VALUE
          """)
          row = cur.fetchone()
          
          print("=" * 50)
          print("üéØ LIVE DATA FROM SNOWFLAKE")
          print("=" * 50)
          print(f"   Customers:     {row[0]:,}")
          print(f"   Total Revenue: ${row[1]:,.2f}")
          print(f"   Avg Revenue:   ${row[2]:,.2f}")
          print("=" * 50)
          print("")
          print("‚úÖ GitHub Actions authenticated via OIDC")
          print("‚úÖ No passwords, keys, or secrets stored!")
          print("‚úÖ Token auto-expires in 10 minutes")
          EOF
